**Questions/tasks:
Part 1: Although the variable PA does not correspond to count data, a Poisson model will be
fitted for the purpose of this exercise.**

**Fit a three-level Poisson random intercept model, with nursing unit representing the level 2
random intercept and hospital representing the level 3 random intercept. Assume normal
distributions for the random intercepts.**

- **Take vague priors for all model parameters. Determine whether an inverse gamma or a
uniform prior is most appropriate for the variability parameter of the random intercepts.**

The random intercepts model we fit here partitions the total variance in variance between hospitals $\epsilon_{h}\sim N(0,\sigma_h^2)$, variance between units within a hospital $\epsilon_{h,u}\sim N(0,\sigma_{h,u}^2)$, and residual variance $\epsilon_{h,u,n}$.

- **First, fit a model without the covariates and check convergence using classical diagnostics.**

As we are asked to model the dependent variable personal accomplishment $Y$ as a Poisson random variable, we use the exponential link function to obtain the following equation:

$$Y=e^{\beta_0+\epsilon_{h}+\epsilon_{h,u}+\epsilon_{h,u,n}}$$

- **Rank the hospitals according to their random effect (in WinBUGS it is possible with the
rank option). Are there hospitals with important differences in the PA baseline level?**

- **In a second step, include the covariates. Are there hospitals genuinely different with
respect to the PA level after adjusting for the covariates in the model?**

- **Check with DIC whether the inclusion of the covariates improves the fit with respect to the
baseline model. Determine what variables to include using this selection criterion.**

- **Give all necessary posterior summary measures of the relevant parameters.**

- **Hint: Standardize all numeric covariates to improve convergence of the MCMC procedure
and give initial values to the regression coefficients and parameters related to variances of
random effects.**

**Part 2: In some cases, there is overdispersion compared to what we would be expect in a Poisson model.**

- **Check whether a negative binomial distribution for PA is better than a Poisson distribution.**

- **Motivate your conclusion.**

## Set up 

First, we install and load the R packages `here` and `runjags`.

```{r load-pkg, message = FALSE}
library(parallel)
library(runjags) # Load runjags
```

```{r}
# set.seed(12345)
```

We have the following variables:

**Nurse level**

- `expe`: experience (years of employment)
- `full`: full time nurse indicator (0/1)
- `pa`: reduced personal accomplishment (PA) dimension of burnout (higher values indicate a higher burnout / reduction in PA)

**Nursing unit level**

- `unit`: a nursing unit identifier
- `unitsur`: surgical unit indicator (0/1)
- `we`: work environment index (higher values indicate a more positive work environment)

**Hospital level**

- `hosp`: a hospital identifier
- `tech`: technical hospital indicator (0/1)
- `teach`: teaching/university hospital indicator (0/1)
- `beds`: number of beds

```{r hist, out.width="50%", fig.align='center'}
hist(
    RN4CAST$pa,
    main = "Histogram of Reduced Personal Accomplishment Score",
    xlab = "Reduced Personal Accomplishment Score"
)
```

The distribution of PA is skewed, with only very few high values. 

## Multilevel Poisson model using runjags

`runjags` only works with complete data, so we first delete the missing values in personal accomplishment.

```{r missing}
RN4CAST_complete <- RN4CAST[!is.na(RN4CAST$pa), ] # Delete missing values in pa
```

Scale all non-factor covariates (except for hosp and unit which are indexes)
```{r scale}
RN4CAST_complete$beds <- c(scale(RN4CAST_complete$beds))
RN4CAST_complete$we <- c(scale(RN4CAST_complete$we))
RN4CAST_complete$expe <- c(scale(RN4CAST_complete$expe))
```

Here the `template.jags` function in the `rjags` package comes in. We can use the syntax of `lme4` to specify our mixed model, and then `template.jags` writes all the jags code. For example, to get the jags syntax for a mixed effects model predicting reduced personal accomplishment, with a fixed intercept, a random intercept for unit, and a random intercept for hospital, we run the chunk below.  


Create model without covariates
```{r template0, message = FALSE, warning=FALSE}
# ?template.jags #run this for more information on the default settings
template_model0 <- template.jags(
    # lme4 syntax for a MEM predicting pa from a random intercept unit + hospital
    formula = pa ~ (1 | unit) + (1 | hosp),
    # specify data source
    data = RN4CAST_complete,
    # specify output file name for the template
    file = "JAGSmodel0.txt",
    # specify Poisson model
    family = "poisson",
    # specify whether you want to write all observations to the template
    write.data = FALSE
)
```

The model is written down in a file, called `JAGSmodel0.txt`, in our current directory.
Specifically, right now (as by default) we set a $\text{Gamma}(0.001, .001)$ prior on the precision of the two random intercepts and a vague $\text{Normal}(0,10^{-6})$ prior on the fixed effects (in this case, a fixed intercept only). Another default is the number of chains (2), which we can always change.

In the first part of the assignment, we're asked to run exactly this model, but instead we have to test what prior to put on the precision of the random intercepts: an inverse gamma or a uniform. In this case, let's say we want to set a $\text{Uniform}(0.001,100)$ prior.
Then, we run the following chunk to get the syntax for this model:

```{r template-uniform, message=FALSE, warning=FALSE}
model0_unif <- template.jags(
    formula = pa ~ (1 | unit) + (1 | hosp),
    data = RN4CAST_complete,
    file = "JAGSmodel0_unif.txt",
    precision.prior = "dunif(0.001, 100)", # make an informed decision later
    family = "poisson",
    write.data = FALSE,
    n.chains = detectCores() # make an informed decision later
)
```

We can now just run the model directly from `R` without needing to manually copy/paste anything.
For this, we use the `run.jags` function to run the model we just specified our syntax for.

```{r run-mod}
# ?run.jags #run this for more information on the default settings
JAGS.mod_uniform <- run.jags(
    # specify the syntax file
    model0_unif,
    # specify the data source (only necessary when write.data = FALSE)
    data = RN4CAST_complete,
    monitor = c(
        "intercept", "unit_precision", "hosp_precision", "beds_coefficient",
        "we_coefficient",
        "expe_coefficient",
        "tech_effect",
        "teach_effect",
        "unitsur_effect",
        "full_effect", "deviance"
    ),
    burnin = 4000, # make informed decision later (choosing speed here)
    sample = 10000, # make informed decision later (choosing speed here)
    method = "rjparallel"
)
dic <- extract(JAGS.mod_uniform, what = "dic")
# ped <- extract(JAGS.mod_uniform, what = "ped")
```

The model ran, and we can inspect its results. 

```{r summary-mod}
summary(JAGS.mod_uniform)
```

## Visualization

We can also visualize all the results easily. The different plot types are `plot.type = c("trace", "ecdf", "histogram", "autocorr", "crosscorr")`.
You can also specify for which variable you want the plot.
The different options are `vars = c("intercept", "unit_precision", "hosp_precision", "deviance", "resid.sum.sq")`.


```{r plot-function}
# Convenience function for plotting
plot_jags <- function(type, var) {
    plot(JAGS.mod_uniform, plot.type = type, vars = var)
}
```

For example, here are all possible plots for the precision of the random intercept for unit:

```{r plots, message=FALSE, out.width="50%", fig.align='center'}
plot_jags("trace", "unit_precision")
plot_jags("ecdf", "unit_precision")
plot_jags("histogram", "unit_precision")
plot_jags("autocorr", "unit_precision")
plot_jags("crosscorr", NA)
```

Our next steps are now the following:

- Everyone should ideally try to read the documentation of `runjags` by the next meeting, so we know what we can and can't do
- Everyone tries to get this set-up and run some models (ideally, the ones asked for)
- We have to choose the parameters (range) of the uniform prior for the precision
- We'll make an informed decision on the number of chains (`n.chains`) specified in `template.jags`
- We'll make an informed decision on the number of burnin iterations and samples


```{r}
plot(JAGS.mod_uniform, layout = c(9, 4))
```
